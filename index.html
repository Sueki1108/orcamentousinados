<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento e Cadastro de Matéria Prima</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="root" class="w-full max-w-4xl bg-white rounded-lg shadow-lg flex flex-col min-h-[700px] md:min-h-[750px]">
        <!-- Fallback message if React fails to load -->
        <div class="p-4 text-center text-gray-600">
            Carregando aplicação... Se esta mensagem persistir, pode haver um erro. Por favor, verifique o console do navegador.
        </div>
    </div>

    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in the browser (for development, not production) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Global error handler for uncaught JavaScript errors
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Um erro inesperado ocorreu:", message, "na linha", lineno, "na coluna", colno, "Source:", source);
            const rootElement = document.getElementById('root');
            if (rootElement) {
                rootElement.innerHTML = `
                    <div class="p-8 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center">
                        <h2 class="font-bold text-lg mb-2">Erro ao carregar a aplicação!</h2>
                        <p>Por favor, tente novamente. Se o problema persistir, entre em contato com o suporte.</p>
                        <p class="text-sm mt-2">Detalhes: ${message} (Linha: ${lineno})</p>
                        <p class="text-xs mt-1">Verifique o console do navegador para mais informações.</p>
                    </div>
                `;
            }
            return true; // Prevents default browser error handling
        };

        // Utility functions for input validation
        const validarEntradaPercentual = (novoTexto) => {
            if (!novoTexto) return true;
            try {
                const valor = parseFloat(novoTexto);
                const partes = novoTexto.split('.');
                if (partes.length > 1 && partes[1].length > 2) {
                    return false;
                }
                return valor >= 0 && valor <= 100;
            } catch (e) {
                return false;
            }
        };

        const validarEntradaDecimal = (novoTexto) => {
            if (!novoTexto) return true;
            try {
                parseFloat(novoTexto);
                const partes = novoTexto.split('.');
                if (partes.length > 1 && partes[1].length > 4) {
                    return false;
                }
                return true;
            } catch (e) {
                return false;
            }
        };

        const validarEntradaNumerica = (novoTexto) => {
            if (!novoTexto) return true;
            try {
                parseFloat(novoTexto);
                const partes = novoTexto.split('.');
                if (partes.length > 1 && partes[1].length > 2) {
                    return false;
                }
                return true;
            } catch (e) {
                return false;
            }
        };

        // Custom Modal Component for prompts and confirmations
        const CustomModal = ({ isOpen, title, message, onConfirm, onCancel, inputPlaceholder, inputValue, onInputChange, showInput, showDeleteButton, onDelete }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
                        <h3 className="text-lg font-bold mb-4 text-gray-800">{title}</h3>
                        <p className="mb-4 text-gray-700">{message}</p>
                        {showInput && (
                            <input
                                type="text"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4"
                                placeholder={inputPlaceholder}
                                value={inputValue}
                                onChange={(e) => onInputChange(e.target.value)}
                            />
                        )}
                        <div className="flex justify-end space-x-2">
                            {showDeleteButton && (
                                <button
                                    onClick={onDelete}
                                    className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-200"
                                >
                                    Excluir
                                </button>
                            )}
                            <button
                                onClick={onCancel}
                                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded transition duration-200"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={onConfirm}
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200"
                            >
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Custom Toast/Notification Component
        const Toast = ({ message, type, onClose }) => {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const textColor = 'text-white';

            if (!message) return null;

            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} ${textColor} p-3 rounded-lg shadow-lg flex items-center justify-between z-50 transition-transform transform duration-300 ease-out translate-y-0 opacity-100`}>
                    <span>{message}</span>
                    <button onClick={onClose} className="ml-4 font-bold">
                        &times;
                    </button>
                </div>
            );
        };


        // Component for the Material Configuration Tab
        const MaterialConfigTab = ({ material, config, onConfigChange }) => {
            const handleInputChange = (field, value) => {
                onConfigChange(material, { ...config, [field]: value });
            };

            return (
                <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2">
                        Margem de Lucro (%):
                    </label>
                    <input
                        type="text"
                        className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                        value={config.margem_lucro || ''}
                        onChange={(e) => {
                            if (validarEntradaPercentual(e.target.value)) {
                                handleInputChange('margem_lucro', e.target.value);
                            }
                        }}
                    />

                    <label className="block text-gray-700 text-sm font-bold mb-2">
                        Hora Máquina (%):
                    </label>
                    <input
                        type="text"
                        className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                        value={config.hora_maquina || ''}
                        onChange={(e) => {
                            if (validarEntradaPercentual(e.target.value)) {
                                handleInputChange('hora_maquina', e.target.value);
                            }
                        }}
                    />

                    <label className="block text-gray-700 text-sm font-bold mb-2">
                        Ferramenta (%):
                    </label>
                    <input
                        type="text"
                        className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                        value={config.ferramenta || ''}
                        onChange={(e) => {
                            if (validarEntradaPercentual(e.target.value)) {
                                handleInputChange('ferramenta', e.target.value);
                            }
                        }}
                    />

                    <label className="block text-gray-700 text-sm font-bold mb-2">
                        Perda por Peça:
                    </label>
                    <input
                        type="text"
                        className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                        value={config.perda_peca || ''}
                        onChange={(e) => {
                            if (validarEntradaDecimal(e.target.value)) {
                                handleInputChange('perda_peca', e.target.value);
                            }
                        }}
                    />
                </div>
            );
        };

        // Component for the "Configurações" tab
        const ConfiguracoesTab = ({ materialsConfig, setMaterialsConfig, onSaveConfig, showToast }) => {
            const [activeMaterialTab, setActiveMaterialTab] = React.useState(0);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalTitle, setModalTitle] = React.useState('');
            const [modalMessage, setModalMessage] = React.useState('');
            const [modalInputPlaceholder, setModalInputPlaceholder] = React.useState('');
            const [modalInputValue, setModalInputValue] = React.useState('');
            const [modalShowInput, setModalShowInput] = React.useState(false);
            const [modalShowDeleteButton, setModalShowDeleteButton] = React.useState(false);
            const [modalConfirmAction, setModalConfirmAction] = React.useState(null);
            const [materialIndexToEdit, setMaterialIndexToEdit] = React.useState(null);

            const handleMaterialConfigChange = (materialName, newConfig) => {
                setMaterialsConfig(prev =>
                    prev.map(mat => (mat.name === materialName ? { ...mat, config: newConfig } : mat))
                );
            };

            const addMaterialTab = () => {
                const defaultName = `Novo${materialsConfig.length + 1}`;
                setModalTitle("Novo Material");
                setModalMessage("Digite o nome do novo material:");
                setModalInputPlaceholder("Nome do Material");
                setModalInputValue(defaultName);
                setModalShowInput(true);
                setModalShowDeleteButton(false);
                setModalConfirmAction(() => (name) => {
                    if (name) {
                        setMaterialsConfig(prev => [...prev, { name, config: {} }]);
                        setActiveMaterialTab(materialsConfig.length); // Select the newly added tab
                        showToast("Material adicionado com sucesso!", "success");
                    } else {
                        showToast("Nome do material não pode ser vazio.", "error");
                    }
                    setIsModalOpen(false);
                });
                setIsModalOpen(true);
            };

            const handleTabClick = (index) => {
                if (index === materialsConfig.length) { // Clicked on '+' tab
                    addMaterialTab();
                } else {
                    setActiveMaterialTab(index);
                }
            };

            const openRenameModal = (index) => {
                setMaterialIndexToEdit(index);
                setModalTitle("Renomear Material");
                setModalMessage("Digite o novo nome do material:");
                setModalInputPlaceholder("Novo Nome");
                setModalInputValue(materialsConfig[index].name);
                setModalShowInput(true);
                setModalShowDeleteButton(true);
                setModalConfirmAction(() => (name) => {
                    if (name && materialIndexToEdit !== null) {
                        setMaterialsConfig(prev =>
                            prev.map((mat, idx) =>
                                idx === materialIndexToEdit ? { ...mat, name: name } : mat
                            )
                        );
                        showToast("Material renomeado com sucesso!", "success");
                    } else {
                        showToast("Nome do material não pode ser vazio.", "error");
                    }
                    setIsModalOpen(false);
                });
                setIsModalOpen(true);
            };

            const deleteMaterial = () => {
                if (materialIndexToEdit !== null) {
                    setModalTitle("Excluir Material");
                    setModalMessage(`Deseja excluir o material '${materialsConfig[materialIndexToEdit].name}'?`);
                    setModalShowInput(false);
                    setModalShowDeleteButton(false); // No delete button in this confirmation modal
                    setModalConfirmAction(() => () => {
                        setMaterialsConfig(prev => prev.filter((_, idx) => idx !== materialIndexToEdit));
                        if (activeMaterialTab >= materialIndexToEdit && activeMaterialTab > 0) {
                            setActiveMaterialTab(activeMaterialTab - 1);
                        } else if (activeMaterialTab === materialIndexToEdit && materialsConfig.length === 1) {
                            setActiveMaterialTab(0); // If last tab deleted, go to first tab (if any)
                        }
                        showToast("Material excluído com sucesso!", "success");
                        setIsModalOpen(false);
                    });
                    setIsModalOpen(true);
                }
            };


            return (
                <div className="p-4 flex flex-col h-full">
                    <div className="flex border-b border-gray-200 overflow-x-auto pb-2">
                        {materialsConfig.map((mat, index) => (
                            <div
                                key={mat.name}
                                className={`flex-shrink-0 cursor-pointer px-4 py-2 border-r border-gray-200 rounded-tl-md rounded-tr-md transition duration-200 ${
                                activeMaterialTab === index ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'
                                }`}
                                onClick={() => handleTabClick(index)}
                                onContextMenu={(e) => {
                                    e.preventDefault();
                                    if (index !== materialsConfig.length) { // Prevent context menu on '+' tab
                                        openRenameModal(index);
                                    }
                                }}
                            >
                                {mat.name}
                            </div>
                        ))}
                        <div
                            className={`flex-shrink-0 cursor-pointer px-4 py-2 rounded-tl-md rounded-tr-md transition duration-200 ${
                            activeMaterialTab === materialsConfig.length ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'
                            }`}
                            onClick={() => handleTabClick(materialsConfig.length)}
                        >
                            +
                        </div>
                    </div>

                    <div className="flex-grow p-4 border border-gray-200 rounded-b-md rounded-tr-md overflow-auto mt-2">
                        {materialsConfig.length > 0 && activeMaterialTab < materialsConfig.length ? (
                            <MaterialConfigTab
                                material={materialsConfig[activeMaterialTab].name}
                                config={materialsConfig[activeMaterialTab].config}
                                onConfigChange={handleMaterialConfigChange}
                            />
                        ) : (
                            <div className="text-center text-gray-500 py-10">
                                {materialsConfig.length === 0 ? "Nenhum material configurado. Clique no '+' para adicionar um novo." : "Clique no '+' para adicionar um novo material."}
                            </div>
                        )}
                    </div>

                    <button
                        onClick={onSaveConfig}
                        className="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
                    >
                        Salvar Configurações
                    </button>

                    <CustomModal
                        isOpen={isModalOpen}
                        title={modalTitle}
                        message={modalMessage}
                        inputPlaceholder={modalInputPlaceholder}
                        inputValue={modalInputValue}
                        onInputChange={setModalInputValue}
                        showInput={modalShowInput}
                        showDeleteButton={modalShowDeleteButton}
                        onConfirm={() => modalConfirmAction(modalInputValue)}
                        onCancel={() => setIsModalOpen(false)}
                        onDelete={deleteMaterial} // Pass deleteMaterial function
                    />
                </div>
            );
        };

        // Component for the "Cadastro de Matéria Prima" tab
        const CadastroMateriaPrimaTab = ({ buchasList, setBuchasList, materialsConfig, showToast }) => {
            const [diCadastro, setDiCadastro] = React.useState('');
            const [deCadastro, setDeCadastro] = React.useState('');
            const [alturaCadastro, setAlturaCadastro] = React.useState('');
            const [materialCadastro, setMaterialCadastro] = React.useState('');
            const [valorCadastro, setValorCadastro] = React.useState('');

            const buscarPerdaPorPeca = React.useCallback((materialName) => {
                const material = materialsConfig.find(m => m.name === materialName);
                if (material && material.config && material.config.perda_peca) {
                    const perda = parseFloat(material.config.perda_peca);
                    return isNaN(perda) ? 0 : perda;
                }
                return null; // Material or config not found
            }, [materialsConfig]);

            const calcularCustoPorMm = React.useCallback((bucha) => {
                const { material, altura, valor } = bucha;
                const alturaUtil = altura - 25;
                if (alturaUtil <= 0) {
                    return "Altura Inválida";
                }

                const materialConfig = materialsConfig.find(m => m.name === material);
                if (!materialConfig || !materialConfig.config) {
                    return "Material Não Configurado";
                }

                const { margem_lucro, hora_maquina, ferramenta } = materialConfig.config;

                try {
                    const margemLucroPercentual = parseFloat(margem_lucro || 0) / 100;
                    const horaMaquinaPercentual = parseFloat(hora_maquina || 0) / 100;
                    const ferramentaPercentual = parseFloat(ferramenta || 0) / 100;

                    const custoMargem = valor * margemLucroPercentual;
                    const custoHoraMaquina = valor * horaMaquinaPercentual;
                    const custoFerramenta = valor * ferramentaPercentual;

                    const custoTotal = valor + custoMargem + custoHoraMaquina + custoFerramenta;
                    const custoPorMm = custoTotal / alturaUtil;
                    return custoPorMm;
                } catch (e) {
                    return "Erro de Configuração";
                }
            }, [materialsConfig]);

            const adicionarBucha = () => {
                if (diCadastro && deCadastro && alturaCadastro && materialCadastro && valorCadastro) {
                    try {
                        const bucha = {
                            material: materialCadastro,
                            di: parseFloat(diCadastro),
                            de: parseFloat(deCadastro),
                            altura: parseFloat(alturaCadastro),
                            valor: parseFloat(valorCadastro),
                        };
                        const custoMm = calcularCustoPorMm(bucha);

                        if (typeof custoMm === 'string') {
                            showToast(`Erro ao Calcular Custo: ${custoMm}`, "error");
                            return;
                        }

                        const newBuchasList = [...buchasList, { ...bucha, custo_mm: custoMm }];
                        setBuchasList(newBuchasList);
                        showToast("Bucha adicionada com sucesso!", "success");

                        // Clear fields
                        setDiCadastro('');
                        setDeCadastro('');
                        setAlturaCadastro('');
                        setMaterialCadastro('');
                        setValorCadastro('');
                    } catch (e) {
                        showToast("Por favor, insira valores numéricos válidos para os diâmetros, altura e valor.", "error");
                    }
                } else {
                    showToast("Por favor, preencha todos os campos para cadastrar a bucha.", "error");
                }
            };

            // Sort buchas for display
            const sortedBuchas = [...buchasList].sort((a, b) => {
                if (a.material < b.material) return -1;
                if (a.material > b.material) return 1;
                return a.de - b.de;
            });

            return (
                <div className="p-4 flex flex-col h-full">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <label className="block text-gray-700 text-sm font-bold">Diâmetro Interno:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={diCadastro}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setDiCadastro(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Diâmetro Externo:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={deCadastro}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setDeCadastro(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Altura:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={alturaCadastro}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setAlturaCadastro(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Material:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={materialCadastro}
                            onChange={(e) => setMaterialCadastro(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Valor da Bucha:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={valorCadastro}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setValorCadastro(e.target.value)}
                        />
                        <div className="col-span-1 sm:col-span-2 lg:col-span-1"></div> {/* Spacer */}
                        <button
                            onClick={adicionarBucha}
                            className="col-span-1 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 transition duration-200"
                        >
                            Incluir
                        </button>
                    </div>

                    <h3 className="text-lg font-bold mb-2 text-gray-800">Buchas Cadastradas:</h3>
                    <div className="overflow-auto border border-gray-200 rounded-md flex-grow">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50 sticky top-0">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DI</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DE</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Altura</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço/mm</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {sortedBuchas.map((bucha, index) => (
                                    <tr key={index} className="hover:bg-gray-50 transition duration-100">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{bucha.material}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{bucha.di.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{bucha.de.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{bucha.altura.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ {bucha.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {typeof bucha.custo_mm === 'number' ? `R$ ${bucha.custo_mm.toLocaleString('pt-BR', { minimumFractionDigits: 4, maximumFractionDigits: 4 })}` : bucha.custo_mm}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Component for the "Orçamento" tab
        const OrcamentoTab = ({ buchasList, materialsConfig, showToast }) => {
            const [diOrcamento, setDiOrcamento] = React.useState('');
            const [deOrcamento, setDeOrcamento] = React.useState('');
            const [alturaOrcamento, setAlturaOrcamento] = React.useState('');
            const [materialOrcamento, setMaterialOrcamento] = React.useState('');
            const [resultadosOrcamento, setResultadosOrcamento] = React.useState('');

            const buscarPerdaPorPeca = React.useCallback((materialName) => {
                const material = materialsConfig.find(m => m.name === materialName);
                if (material && material.config && material.config.perda_peca) {
                    const perda = parseFloat(material.config.perda_peca);
                    return isNaN(perda) ? 0 : perda;
                }
                return null; // Material or config not found
            }, [materialsConfig]);

            const calcularCustoPorMm = React.useCallback((bucha) => {
                const { material, altura, valor } = bucha;
                const alturaUtil = altura - 25;
                if (alturaUtil <= 0) {
                    return "Altura Inválida";
                }

                const materialConfig = materialsConfig.find(m => m.name === material);
                if (!materialConfig || !materialConfig.config) {
                    return "Material Não Configurado";
                }

                const { margem_lucro, hora_maquina, ferramenta } = materialConfig.config;

                try {
                    const margemLucroPercentual = parseFloat(margem_lucro || 0) / 100;
                    const horaMaquinaPercentual = parseFloat(hora_maquina || 0) / 100;
                    const ferramentaPercentual = parseFloat(ferramenta || 0) / 100;

                    const custoMargem = valor * margemLucroPercentual;
                    const custoHoraMaquina = valor * horaMaquinaPercentual;
                    const custoFerramenta = valor * ferramentaPercentual;

                    const custoTotal = valor + custoMargem + custoHoraMaquina + custoFerramenta;
                    const custoPorMm = custoTotal / alturaUtil;
                    return custoPorMm;
                } catch (e) {
                    return "Erro de Configuração";
                }
            }, [materialsConfig]);

            const realizarOrcamento = () => {
                if (diOrcamento && deOrcamento && alturaOrcamento && materialOrcamento) {
                    try {
                        const diDesejado = parseFloat(diOrcamento);
                        const deDesejado = parseFloat(deOrcamento);
                        const alturaPeca = parseFloat(alturaOrcamento);

                        let buchasCompativeis = [];

                        for (const bucha of buchasList) {
                            if (bucha.material === materialOrcamento && bucha.di <= diDesejado && bucha.de >= deDesejado) {
                                buchasCompativeis.push(bucha);
                            }
                        }

                        let resultado = '';

                        if (buchasCompativeis.length > 0) {
                            const perdaPorPeca = buscarPerdaPorPeca(materialOrcamento);
                            if (perdaPorPeca !== null) {
                                const alturaTotalUtilizada = alturaPeca + perdaPorPeca;

                                buchasCompativeis.sort((a, b) => a.de - b.de); // Sort by DE

                                const primeiraBucha = buchasCompativeis[0];
                                const precoPrimeiraPeca = alturaTotalUtilizada * (primeiraBucha.custo_mm || 0);

                                resultado += `Orçamento para peça (Material: ${materialOrcamento}, DI: ${diDesejado.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, DE: ${deDesejado.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, Altura: ${alturaPeca.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}):\n`;
                                resultado += `- Bucha utilizada (primeira compatível): DI: ${primeiraBucha.di.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, DE: ${primeiraBucha.de.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, Altura da Bucha: ${primeiraBucha.altura.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, Preço da Peça: R$ ${precoPrimeiraPeca.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n\n`;

                                if (buchasCompativeis.length > 1) {
                                    resultado += "Outras buchas compatíveis e seus preços para a mesma peça:\n";
                                    for (const buchaAlternativa of buchasCompativeis.slice(1)) {
                                        const precoAlternativo = alturaTotalUtilizada * (buchaAlternativa.custo_mm || 0);
                                        resultado += `- DI: ${buchaAlternativa.di.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, DE: ${buchaAlternativa.de.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, Altura da Bucha: ${buchaAlternativa.altura.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, Preço da Peça: R$ ${precoAlternativo.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
                                    }
                                } else {
                                    resultado += "Apenas uma bucha compatível encontrada.\n";
                                }
                            } else {
                                resultado = `Erro: Configuração de 'Perda por Peça' não encontrada para o material '${materialOrcamento}'.`;
                                showToast(resultado, "error");
                            }
                        } else {
                            resultado = `Nenhuma bucha compatível encontrada para o material '${materialOrcamento}' com DI <= ${diDesejado.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} e DE >= ${deDesejado.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}.`;
                            showToast(resultado, "error");
                        }
                        setResultadosOrcamento(resultado);
                    } catch (e) {
                        setResultadosOrcamento("Erro: Por favor, insira valores numéricos válidos para os diâmetros e altura.");
                        showToast("Erro: Por favor, insira valores numéricos válidos para os diâmetros e altura.", "error");
                    }
                } else {
                    setResultadosOrcamento("Erro: Por favor, preencha todos os campos para realizar o orçamento.");
                    showToast("Erro: Por favor, preencha todos os campos para realizar o orçamento.", "error");
                }
            };

            return (
                <div className="p-4 flex flex-col h-full">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <label className="block text-gray-700 text-sm font-bold">Diâmetro Interno Desejado:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={diOrcamento}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setDiOrcamento(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Diâmetro Externo Desejado:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={deOrcamento}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setDeOrcamento(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Altura da Peça:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={alturaOrcamento}
                            onChange={(e) => validarEntradaNumerica(e.target.value) && setAlturaOrcamento(e.target.value)}
                        />
                        <label className="block text-gray-700 text-sm font-bold">Material:</label>
                        <input
                            type="text"
                            className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                            value={materialOrcamento}
                            onChange={(e) => setMaterialOrcamento(e.target.value)}
                        />
                        <div className="col-span-2"></div> {/* Spacer */}
                        <button
                            onClick={realizarOrcamento}
                            className="col-span-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
                        >
                            Orçar
                        </button>
                    </div>

                    <div className="flex-grow border border-gray-200 rounded-md p-4 overflow-auto">
                        <h3 className="text-lg font-bold mb-2 text-gray-800">Resultados do Orçamento:</h3>
                        <pre className="whitespace-pre-wrap text-sm text-gray-800">{resultadosOrcamento}</pre>
                    </div>
                </div>
            );
        };

        function App() {
            // State for active tab
            const [activeTab, setActiveTab] = React.useState('orcamento'); // 'orcamento', 'cadastro', 'configuracoes'

            // State for material configurations, initialized from localStorage or default
            const [materialsConfig, setMaterialsConfig] = React.useState(() => {
                try {
                    const storedConfig = localStorage.getItem('materialsConfig');
                    return storedConfig ? JSON.parse(storedConfig) : [
                        { name: "ECOPUR", config: {} },
                        { name: "ECOTAL", config: {} },
                        { name: "ECOFKM", config: {} },
                        { name: "TEFLON PURO", config: {} },
                        { name: "TEFLO BRONZE", config: {} },
                        { name: "TEFLON GRAFITE", config: {} },
                    ];
                } catch (error) {
                    console.error("Failed to parse materialsConfig from localStorage:", error);
                    return [
                        { name: "ECOPUR", config: {} },
                        { name: "ECOTAL", config: {} },
                        { name: "ECOFKM", config: {} },
                        { name: "TEFLON PURO", config: {} },
                        { name: "TEFLO BRONZE", config: {} },
                        { name: "TEFLON GRAFITE", config: {} },
                    ];
                }
            });

            // State for bushing list, initialized from localStorage or empty array
            const [buchasList, setBuchasList] = React.useState(() => {
                try {
                    const storedBuchas = localStorage.getItem('buchasList');
                    return storedBuchas ? JSON.parse(storedBuchas) : [];
                } catch (error) {
                    console.error("Failed to parse buchasList from localStorage:", error);
                    return [];
                }
            });

            // State for toast notifications
            const [toastMessage, setToastMessage] = React.useState('');
            const [toastType, setToastType] = React.useState('success');

            // Effect to save materialsConfig to localStorage whenever it changes
            React.useEffect(() => {
                localStorage.setItem('materialsConfig', JSON.stringify(materialsConfig));
            }, [materialsConfig]);

            // Effect to save buchasList to localStorage whenever it changes
            React.useEffect(() => {
                localStorage.setItem('buchasList', JSON.stringify(buchasList));
            }, [buchasList]);

            // Function to show a toast message
            const showToast = (message, type = 'success') => {
                setToastMessage(message);
                setToastType(type);
                setTimeout(() => {
                    setToastMessage('');
                }, 3000); // Hide after 3 seconds
            };

            // Memoized function to calculate cost per mm
            const calculateCustoPorMm = React.useCallback((bucha) => {
                const { material, altura, valor } = bucha;
                const alturaUtil = altura - 25; // Fixed value for height reduction
                if (alturaUtil <= 0) {
                    return "Altura Inválida";
                }

                const materialConfig = materialsConfig.find(m => m.name === material);
                if (!materialConfig || !materialConfig.config) {
                    return "Material Não Configurado";
                }

                const { margem_lucro, hora_maquina, ferramenta } = materialConfig.config;

                try {
                    const margemLucroPercentual = parseFloat(margem_lucro || 0) / 100;
                    const horaMaquinaPercentual = parseFloat(hora_maquina || 0) / 100;
                    const ferramentaPercentual = parseFloat(ferramenta || 0) / 100;

                    const custoMargem = valor * margemLucroPercentual;
                    const custoHoraMaquina = valor * horaMaquinaPercentual;
                    const custoFerramenta = valor * ferramentaPercentual;

                    const custoTotal = valor + custoMargem + custoHoraMaquina + custoFerramenta;
                    const custoPorMm = custoTotal / alturaUtil;
                    return custoPorMm;
                } catch (e) {
                    return "Erro de Configuração";
                }
            }, [materialsConfig]);


            // Function to save configurations and recalculate bushing prices
            const salvarConfiguracoes = () => {
                const updatedBuchasList = buchasList.map(bucha => {
                    const newCustoMm = calculateCustoPorMm(bucha);
                    if (typeof newCustoMm === 'string') {
                        console.error(`Erro ao recalcular preço para ${bucha.material}: ${newCustoMm}`);
                        return { ...bucha, custo_mm: "Erro" };
                    }
                    return { ...bucha, custo_mm: newCustoMm };
                });
                setBuchasList(updatedBuchasList);
                showToast("Configurações salvas com sucesso!", "success");
            };

            return (
                <div className="min-h-screen bg-gray-100 p-4 font-sans flex flex-col">
                    <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">
                        Orçamento e Cadastro de Matéria Prima
                    </h1>

                    <div className="bg-white rounded-lg shadow-lg flex-grow flex flex-col">
                        <div className="flex border-b border-gray-200">
                            <button
                                className={`px-4 py-2 sm:px-6 sm:py-3 text-base sm:text-lg font-medium rounded-tl-lg transition duration-200 ${
                                activeTab === 'orcamento' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'
                                }`}
                                onClick={() => setActiveTab('orcamento')}
                            >
                                Orçamento
                            </button>
                            <button
                                className={`px-4 py-2 sm:px-6 sm:py-3 text-base sm:text-lg font-medium transition duration-200 ${
                                activeTab === 'cadastro' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'
                                }`}
                                onClick={() => setActiveTab('cadastro')}
                            >
                                Cadastro de Matéria Prima
                            </button>
                            <button
                                className={`px-4 py-2 sm:px-6 sm:py-3 text-base sm:text-lg font-medium rounded-tr-lg transition duration-200 ${
                                activeTab === 'configuracoes' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'
                                }`}
                                onClick={() => setActiveTab('configuracoes')}
                            >
                                Configurações
                            </button>
                        </div>

                        <div className="flex-grow overflow-hidden">
                            {activeTab === 'orcamento' && (
                                <OrcamentoTab buchasList={buchasList} materialsConfig={materialsConfig} showToast={showToast} />
                            )}
                            {activeTab === 'cadastro' && (
                                <CadastroMateriaPrimaTab
                                    buchasList={buchasList}
                                    setBuchasList={setBuchasList}
                                    materialsConfig={materialsConfig}
                                    showToast={showToast}
                                />
                            )}
                            {activeTab === 'configuracoes' && (
                                <ConfiguracoesTab
                                    materialsConfig={materialsConfig}
                                    setMaterialsConfig={setMaterialsConfig}
                                    onSaveConfig={salvarConfiguracoes}
                                    showToast={showToast}
                                />
                            )}
                        </div>
                    </div>
                    <Toast message={toastMessage} type={toastType} onClose={() => setToastMessage('')} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
